####################################
# Globals for toggles and states
####################################
[gcode_macro _globals]
variable_filament_sensor_enabled: 1     # 1 = enable filament sensor when active, 0 = disable
variable_beeping_enabled: 1             # 1 = enable beeps (except during certain ops) - kept but unused since no speaker
variable_afc_enabled: 1                 # 1 = BoxTurtle/AFC active (auto tool changes via Tn), 0 = bypassed/manual mode
gcode:
    # This macro holds global variables - do not add gcode here

####################################
# Helper: Conditional Beep (commented calls since no speaker)
####################################
[gcode_macro CONDITIONAL_BEEP]
gcode:
    {% set i    = params.I   |default(1)|int %}
    {% set dur  = params.DUR |default(100)|int %}
    {% set freq = params.FREQ|default(2000)|int %}
    {% set BEEPING_ENABLED = printer["gcode_macro _globals"].beeping_enabled|default(-1)|int %}
    {% if BEEPING_ENABLED == 1 %}
        BEEP I={i} DUR={dur} FREQ={freq}
    {% endif %}

####################################
# Helper: Adjust Filament Sensor
####################################
[gcode_macro ADJUST_FILAMENT_SENSOR_STATUS]
gcode:
    {% set NEWSTATUS = params.ENABLE|default(-1)|int %}
    {% set FILAMENT_SENSOR_ENABLED = printer["gcode_macro _globals"].filament_sensor_enabled|default(-1)|int %}
    {% if FILAMENT_SENSOR_ENABLED == 1 and NEWSTATUS != -1 %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE={NEWSTATUS}
    {% endif %}

####################################
# Load / Unload Helpers (unchanged)
####################################
[gcode_macro LOAD_FILAMENT]
gcode:
    M83                     ; relative extruder
    G1 E30 F300             ; load filament
    G1 E15 F150             ; prime nozzle
    M82                     ; absolute extruder

[gcode_macro UNLOAD_FILAMENT]
gcode:
    M83
    G1 E10 F300             ; soften tip
    G1 E-40 F1800           ; main retract
    G4 P200
    G1 E-40 F1800
    G4 P200
    G1 E-20 F1800           ; final retract past gears
    M82

####################################
# M600: Manual Filament Change / Pause
# - Safe with BoxTurtle: only runs if afc_enabled=0 (or remove check)
# - Long timeout, hotend off, big retract, sensor disable
# - Beeps commented out (no speaker)
####################################
[gcode_macro M600]
gcode:
    # Alert user (beep pattern commented since no speaker)
    # CONDITIONAL_BEEP i=1 dur=300
    # CONDITIONAL_BEEP i=1 dur=100
    # CONDITIONAL_BEEP i=1 dur=100
    # CONDITIONAL_BEEP i=1 dur=300
    # CONDITIONAL_BEEP i=1 dur=300
    # CONDITIONAL_BEEP i=1 dur=100
    # CONDITIONAL_BEEP i=1 dur=300
    # CONDITIONAL_BEEP i=1 dur=100
    # CONDITIONAL_BEEP i=1 dur=300

    {% set afc_active = printer["gcode_macro _globals"].afc_enabled|default(1)|int %}
    {% if afc_active == 1 %}
        { action_respond_info("AFC/BoxTurtle is active (afc_enabled=1). Use Tn commands for swaps or set afc_enabled=0 in _globals to allow manual M600.") }
        # Optional: could add a visual cue or just silent exit
    {% else %}
        PAUSE                   ; trigger our custom PAUSE below
    {% endif %}

####################################
# PAUSE: Custom pause logic (renames base)
# - Z-hop, retract, park front-center, big unload retract, hotend off, long timeout
# - Beeps commented out
####################################
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    {% set z = params.Z|default(10)|int %}   ; z-hop amount (configurable via PAUSE Z=15 etc.)

    {% if printer['pause_resume'].is_paused|int == 0 %}
        # Save resume data
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop  VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}

        ADJUST_FILAMENT_SENSOR_STATUS ENABLE=0
        SAVE_GCODE_STATE NAME=PAUSE

        BASE_PAUSE                           ; actual Klipper pause

        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 E-0.7 F2700                   ; small retract to prevent ooze
            G1 Z{z} F900                     ; z-hop
        {% else %}
            { action_respond_info("Pause z-hop exceeds max Z - skipping hop") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}

        G90
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y + 5} F6000  ; park front center

        SAVE_GCODE_STATE NAME=PAUSEPARK      ; save parked pos (in case head moved during pause)

        # Big retract to clear path for manual swap
        M83
        G1 E-40 F1000
        G4 P200
        G1 E-40 F1000
        G4 P200
        G1 E-20 F1000
        M82

        M104 S0                              ; turn hotend off (safe for long pauses)
        SET_IDLE_TIMEOUT TIMEOUT=43200       ; 12 hours - plenty for manual filament swap

        # Optional alert (commented)
        # CONDITIONAL_BEEP i=2 dur=500 freq=1500  ; could use for pause confirmation if speaker added later
    {% endif %}

####################################
# RESUME: Restore after pause/swap
# - Beeps commented out
####################################
[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    {% set e = params.E|default(2.5)|float %}   ; prime amount on resume

    {% if printer['pause_resume'].is_paused|int == 1 %}
        ADJUST_FILAMENT_SENSOR_STATUS ENABLE=1
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}  ; restore original timeout

        {% if etemp > 0 %}
            M109 S{etemp|int}                ; wait for hotend to re-heat
        {% endif %}

        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100   ; back to parked pos
        G91
        M83

        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900        ; lower Z + prime
        {% else %}
            G1 Z{zhop * -1} F900             ; just lower Z (cold hotend case)
        {% endif %}

        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60        ; full restore
        BASE_RESUME                                         ; resume print

        # Optional resume alert (commented)
        # CONDITIONAL_BEEP i=1 dur=200 freq=2500
    {% endif %}

####################################
# BEEP helper (kept but unused - calls commented where needed)
####################################
[gcode_macro BEEP]
description: BEEP I=3 DUR=200 FREQ=2000 - Beep multiple times (unused without speaker)
gcode:
    {% set i    = params.I   |default(1)|int %}
    {% set dur  = params.DUR |default(100)|int %}
    {% set freq = params.FREQ|default(2000)|int %}
    {% for _ in range(i) %}
        SET_PIN PIN=BEEPER_pin VALUE=0.8 CYCLE_TIME={1.0/freq if freq > 0 else 1}
        G4 P{dur}
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P{dur}
    {% endfor %}